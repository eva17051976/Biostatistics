---
title: "Биостатистика. ДЗ5. Некрасова Е.В."
output: html_document
date: "2024-04-07"
---
# Загрузка библиотек
```{r}
library(readr)
library(ggplot2)
library(tidyr)
library(dplyr)
```

# Описание ДЗ
Для выполнения первых двух заданий загрузите датасет Breast Cancer Wisconsin.
В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).

## Загрузка датасета и проверка доступа к данным
```{r}
data <- read.csv("C:/Users/UserHome/Desktop/Биостатистика/ДЗ 5/wisconsin_breast_cancer.csv")
head(data, 7)
```

# Задание 1 (2 балла)
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

## Создание регрессионной модели
```{r}
model <- lm(area_mean ~ radius_mean + perimeter_mean + symmetry_mean, data = data)
```

## Построение графиков
```{r}  
plot1 <- ggplot(data, aes(x = radius_mean, y = area_mean)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(x = "Radius Mean", y = "Area Mean") +
  ggtitle("Regression Plot: Radius Mean vs Area Mean")

plot2 <- ggplot(data, aes(x = radius_mean, y = perimeter_mean)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(x = "Radius Mean", y = "Perimeter Mean") +
  ggtitle("Regression Plot: Radius Mean vs Perimeter Mean")

plot3 <- ggplot(data, aes(x = radius_mean, y = symmetry_mean)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  labs(x = "Radius Mean", y = "Symmetry Mean") +
  ggtitle("Regression Plot: Radius Mean vs Symmetry Mean")

# Вывод графиков
plot1
plot2
plot3
```

#Комментарий к графикам:

Regression Plot: Radius Mean vs Area Mean: На этом графике представлена зависимость средней площади опухоли от среднего радиуса. Точки данных распределены вдоль прямой, наложенной на график, что указывает на линейную зависимость между этими двумя переменными. Коэффициент наклона прямой (угол наклона) отражает скорость изменения средней площади при изменении среднего радиуса.

Regression Plot: Radius Mean vs Perimeter Mean: На этом графике представлена зависимость среднего периметра опухоли от среднего радиуса. Аналогично первому графику, наблюдается линейная зависимость между этими переменными.

Regression Plot: Radius Mean vs Symmetry Mean: На этом графике представлена зависимость средней симметричности опухоли от среднего радиуса. В данном случае также можно наблюдать линейную зависимость, однако она менее выражена, и точки данных распределены вдоль прямой с большим разбросом.


# Задание 2 (2 балла)
Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).
Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

# Преобразование диагноза в 1 и 0
```{r}
data$diagnosis <- ifelse(data$diagnosis == "M", 1, 0)
```

# Модель среднего радиуса, площади и текстуры
```{r}
model1 <- glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = binomial)
```

# График
```{r}
plot1 <- ggplot(data, aes(x = radius_mean, y = diagnosis)) +
  geom_point() +
  geom_smooth(method = "glm", method.args = list(family = "binomial"), formula = y ~ x) +
  labs(x = "Mean Radius", y = "Probability of Malignant Tumor") +
  ggtitle("Logistic Regression: Mean Radius vs Diagnosis")
```

# Вывод графика
```{r}
plot1
```

Поскольку показатели p-value превышают установленный уровень значимости alpha, поэтому результаты логистической регрессии с взаимодействием всех 3 факторов статистически не значимы.

# Задание 3 (6 балла)
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.
Датасет содержит следующий набор переменных:
inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.
Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.
Изучите работу функций Surv(), survfit() и ggsurvplot():
Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?

# Загрузка библиотеки, датасета и проверка доступа к данным
```{r}
library(survival)
library(survminer)
lung
head(lung, 7)
```

# Создадим переменную event, отражающую наличие или отсутствие смерти пациента:
```{r}
lung$event <- ifelse(lung$status == 2, 1, 0)
head(lung, 7)
```

# Построим кривые выживаемости в зависимости от пола:
```{r}
fit <- survfit(Surv(time, event) ~ sex, lung)
ggsurvplot(fit, data = lung, risk.table = TRUE)
```

# Построим график кумулятивной функции рисков для пола:
```{r}
fit_sex <- survfit(Surv(time, event) ~ sex, lung)
ggsurvplot(fit_sex, data = lung, conf.int = TRUE, risk.table = TRUE, cumevents = TRUE, 
           legend.title = "Пол", legend.labs = c("Мужчины", "Женщины"))
```

# Построим регрессию Кокса и оценим влияние пола на выживаемость:
```{r}
cox_model <- coxph(Surv(time, event) ~ sex, lung)
summary(cox_model)
```

Таким образом, наш анализ был осуществлен исключительно на пациентах, которые столкнулись со смертью, что представляет собой недостаточный подход при оценке выживаемости и риска. Как видим, в такой методологии анализа мы не наблюдаем статистически обоснованных различий между группами ни в отношении шансов на выживание, ни в риске наступления смерти.
Однако, при более всестороннем анализе, включая всех пациентов и учет цензурированных данных, возможно, мы могли бы обнаружить значимые отличия.